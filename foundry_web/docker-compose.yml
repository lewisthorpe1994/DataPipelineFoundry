version: "3.9"

services:
  backend:
    build:
      context: ..
      dockerfile: foundry_web/docker/backend.Dockerfile
    working_dir: /workspace/FlowFoundry
    volumes:
      - ..:/workspace/FlowFoundry
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/workspace/FlowFoundry/target
    environment:
      RUST_LOG: info
    ports:
      - "8085:8085"

  frontend:
    build:
      context: ..
      dockerfile: foundry_web/docker/frontend.Dockerfile
    working_dir: /workspace/FlowFoundry/foundry_web/ui
    command: bash -lc "npm install && npm run dev -- --host 0.0.0.0 --port 5173"
    environment:
      CHOKIDAR_USEPOLLING: "true"
#      VITE_BACKEND_URL: http://backend:8085
      FOUNDRY_BACKEND_PROXY: http://backend:8085
    volumes:
      - ..:/workspace/FlowFoundry
      - node-modules:/workspace/FlowFoundry/foundry_web/ui/node_modules
    ports:
      - "5173:5173"
    depends_on:
      - backend

volumes:
  cargo-cache:
  target-cache:
  node-modules:
